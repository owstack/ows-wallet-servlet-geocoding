"use strict";angular.module("owsWalletPlugin",["gettext","ngLodash","owsWalletPluginClient","owsWalletPlugin.apiHandlers","owsWalletPlugin.services"]),angular.module("owsWalletPlugin.apiHandlers",[]),angular.module("owsWalletPlugin.services",[]),angular.module("owsWalletPlugin").config(function($pluginConfigProvider){$pluginConfigProvider.router.routes([{path:"/address",method:"GET",handler:"getAddress"},{path:"/position",method:"GET",handler:"getPosition"},{path:"/service",method:"PUT",handler:"service"}])}).run(function(){owswallet.Plugin.ready(function(){})}),angular.module("owsWalletPlugin.services").factory("dataService",[function(){var root={states:[{abbr:"AL",name:"Alabama"},{abbr:"AK",name:"Alaska"},{abbr:"AZ",name:"Arizona"},{abbr:"AR",name:"Arkansas"},{abbr:"CA",name:"California"},{abbr:"CO",name:"Colorado"},{abbr:"CT",name:"Connecticut"},{abbr:"DE",name:"Delaware"},{abbr:"FL",name:"Florida"},{abbr:"GA",name:"Georgia"},{abbr:"HI",name:"Hawaii"},{abbr:"ID",name:"Idaho"},{abbr:"IL",name:"Illinois"},{abbr:"IN",name:"Indiana"},{abbr:"IA",name:"Iowa"},{abbr:"KS",name:"Kansas"},{abbr:"KY",name:"Kentucky"},{abbr:"LA",name:"Louisiana"},{abbr:"ME",name:"Maine"},{abbr:"MD",name:"Maryland"},{abbr:"MA",name:"Massachusetts"},{abbr:"MI",name:"Michigan"},{abbr:"MN",name:"Minnesota"},{abbr:"MS",name:"Mississippi"},{abbr:"MO",name:"Missouri"},{abbr:"MT",name:"Montana"},{abbr:"NE",name:"Nebraska"},{abbr:"NV",name:"Nevada"},{abbr:"NH",name:"New Hampshire"},{abbr:"NJ",name:"New Jersey"},{abbr:"NM",name:"New Mexico"},{abbr:"NY",name:"New York"},{abbr:"NC",name:"North Carolina"},{abbr:"ND",name:"North Dakota"},{abbr:"OH",name:"Ohio"},{abbr:"OK",name:"Oklahoma"},{abbr:"OR",name:"Oregon"},{abbr:"PA",name:"Pennsylvania"},{abbr:"RI",name:"Rhode Island"},{abbr:"SC",name:"South Carolina"},{abbr:"SD",name:"South Dakota"},{abbr:"TN",name:"Tennessee"},{abbr:"TX",name:"Texas"},{abbr:"UT",name:"Utah"},{abbr:"VT",name:"Vermont"},{abbr:"VA",name:"Virginia"},{abbr:"WA",name:"Washington"},{abbr:"WV",name:"West Virginia"},{abbr:"WI",name:"Wisconsin"},{abbr:"WY",name:"Wyoming"}]};return root}]),angular.module("owsWalletPlugin.services").factory("openStreetMapService",["$log","dataService","lodash","owsWalletPluginClient.api.Device","owsWalletPluginClient.api.Http",function($log,dataService,lodash,Device,Http){var openStreetMapApi,root={},apiUrl=(owswallet.Plugin.isCordova(),"https://nominatim.openstreetmap.org/");function improveAddress(address){return address.stateName=address.state,address.state=lodash.find(dataService.states,{name:address.stateName}).abbr,address}function getError(response,callerId){return response.message?{id:"unexpected_error",message:response.message}:($log.error("OpenStreetMap: "+callerId+" - "+response.toString()),response.status&&response.status<=0?{id:"network_error",message:"Network error"}:{id:"unexpected_error",message:response.toString()})}return root.init=function(clientId,config){return new Promise(function(resolve,reject){if(!config){var error="Could not initialize API service: no plugin configuration provided";$log.error(error),reject(error)}var info={urls:{url:"https://www.openstreetmap.org",githubUrl:"https://github.com/openstreetmap/Nominatim"}};return openStreetMapApi=new Http(apiUrl,{headers:{"Content-Type":"application/json",Accept:"application/json"}}),resolve({info:info})})},root.getAddress=function(position){return new Promise(function(resolve,reject){position?openStreetMapApi.get("reverse?format=json&lat="+position.coords.latitude+"&lon="+position.coords.longitude).then(function(response){resolve(improveAddress(response.data.address))}).catch(function(response){reject(getError(response,"getAddress"))}):Device.getCurrentPosition().then(function(position){return openStreetMapApi.get("reverse?format=json&lat="+position.coords.latitude+"&lon="+position.coords.longitude)}).then(function(response){resolve(improveAddress(response.data.address))}).catch(function(response){reject(getError(response,"getAddress"))})})},root.getPosition=function(address){return new Promise(function(resolve,reject){if(address){var encodedAddress=encodeURI(address.number||","+address.street||","+address.city||","+address.state||","+address.postalCode||","+address.country||"");openStreetMapApi.get("search?format=json&q="+encodedAddress).then(function(response){resolve(response.data)}).catch(function(response){reject(getError(response,"getPosition"))})}else Device.getCurrentPosition().then(function(position){resolve({coords:{latitude:position.coords.latitude,longitude:position.coords.longitude}})}).catch(function(response){reject(getError(response,"getPosition"))})})},root}]),angular.module("owsWalletPlugin.apiHandlers").factory("getAddress",["openStreetMapService","owsWalletPluginClient.api.Utils",function(openStreetMapService,Utils){var root={},REQUIRED_DATA=[];return root.respond=function(message,callback){var position=message.request.data.position,missing=Utils.checkRequired(REQUIRED_DATA,message.request.data);if(missing.length>0)return message.response={statusCode:400,statusText:"REQUEST_NOT_VALID",data:{message:"The request does not include "+missing.toString()+"."}},callback(message);openStreetMapService.getAddress(position).then(function(address){var response=address;return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message||error.toString()}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").factory("getPosition",["openStreetMapService","owsWalletPluginClient.api.Utils",function(opemStreetMapService,Utils){var root={},REQUIRED_DATA=[];return root.respond=function(message,callback){var address=message.request.data.address,missing=Utils.checkRequired(REQUIRED_DATA,message.request.data);if(missing.length>0)return message.response={statusCode:400,statusText:"REQUEST_NOT_VALID",data:{message:"The request does not include "+missing.toString()+"."}},callback(message);openStreetMapService.getPosition(address).then(function(position){var response=position;return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message||error.toString()}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("service",["openStreetMapService","owsWalletPluginClient.api.Utils",function(openStreetMapService,Utils){var root={},REQUIRED_DATA=[];return root.respond=function(message,callback){var missing=Utils.checkRequired(REQUIRED_DATA,message.request.data);if(missing.length>0)return message.response={statusCode:400,statusText:"REQUEST_NOT_VALID",data:{message:"The request does not include "+missing.toString()+"."}},callback(message);var clientId=message.header.clientId,pluginConfig=message.request.data.config;if(!pluginConfig)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required configuration."}},callback(message);openStreetMapService.init(clientId,pluginConfig).then(function(){return message.response={statusCode:200,statusText:"OK",data:{}},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]);